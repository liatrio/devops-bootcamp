# Azure Virtual Machines

In this section we will demonstrate how to create a virtual machine instance in Azure from a marketplace image and perform post configuration using a cloud-init script.

## Create an Azure VM from a marketplace image and configure with cloud-init



1. Log into Azure CLI and select the correct subscription

```
az login
az acccount set --subscription "liatrio-sandbox"
```

2. List VM images available in an Azure region that are based on Ubuntu Linux.

```
az vm image list -f Ubuntu --publisher Canonical --location westus --all --output table --sku 18.04
```

3. Create a cloud-init script that configures an Apache web server.

```
#cloud-config
package_update: true
package_upgrade: true
packages:
  - apache2
write_files:
  - owner: root:root
    path: /var/www/html/index.html
    content: |
      <html><body><h1>DevOps Bootcamp section 8.1</h1>
      I was generated from cloud-init
      </body></html>
```

4. Generate some temporary SSH keys to use for the new VM.

```
ssh-keygen -m PEM -t rsa -b 4096
```

5. Create resource group.

```
az group create --name RG-brent-bootcamp --location westus
```

6. Create VM using cloud-init script.

```
az vm create \
    --resource-group RG-brent-bootcamp \
    --name brentw-test-VM \
    --size Standard_B1s \
    --image UbuntuLTS \
    --admin-username azureuser \
    --ssh-key-values /tmp/id_rsa.pub \
    --custom-data /tmp/cloud-init.txt
```

**(note: copy the public IP that is output after VM creation)**

7. SSH into VM using private key you generated in step 4.

```
ssh -i /tmp/id_rsa azureuser@public_IP
```

8. Open web traffic to the VM.

```
az vm open-port --port 80 --resource-group RG-brent-bootcamp --name brentw-test-VM
```

9. Test you can reach the website.

10. Cleanup.

```
az group delete -n RG-brent-bootcamp
```
