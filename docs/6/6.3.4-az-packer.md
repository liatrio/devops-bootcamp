# Packer and shared VM Images on Azure

In this section we will demonstrate how Packer can be used to create images in Azure Shared Image Galleries. We will build upon the learnings from previous sections and use this custom image to re-create our VMSS from section 6.3.3. Using Packer to create our own custom images, instead of Azure marketplace images, gives us the ability apply configurations or security hardening practices that are specific to our needs. Packer can also use various provisioners (eg. Ansible, Shell) to perform image customization.

[Shared Image Gallery](https://docs.microsoft.com/en-us/azure/virtual-machines/shared-image-galleries) is a service that helps you build structure and organization around your custom images. While we could create custom images in Azure without using a Shared Image Gallery, using the Shared Image Gallery allows us to easily share images across subscriptions.

## Create a Shared Image Gallery and use Packer to populate it with a custom Azure VM image

1. Log into Azure CLI and select the correct subscription

```
az login
az acccount set --subscription "liatrio-sandbox"
```

2. Create resource group for the Shared Image Gallery and associated resources.

```
RESOURCE_GROUP=RG-brent-bootcamp
LOCATION=westus
az group create --name $RESOURCE_GROUP --location $LOCATION
```

3. Create a Shared Image Gallery

```
GALLERY=SIG_brent_bootcamp
az sig create \
  --resource-group $RESOURCE_GROUP \
  --gallery-name $GALLERY
```

4. Create image definition.

```
IMAGE=Ubuntu1804
COMPANY=bootcamp
az sig image-definition create \
  --resource-group $RESOURCE_GROUP \
  --gallery-name $GALLERY \
  --gallery-image-definition $IMAGE \
  --publisher $COMPANY \
  --offer UbuntuServer \
  --sku 18.04-LTS \
  --os-type linux
```

4. Create a custom image using Packer with the [azure-rm](https://www.packer.io/docs/builders/azure/arm) builder.

```
cat <<EOF > /tmp/ubuntu1804.json
{
    "builders": [
      {
        "type": "azure-arm",
        "use_azure_cli_auth": true,
    
        "os_type": "Linux",
        "os_disk_size_gb": "50",
        "image_publisher": "Canonical",
        "image_offer": "UbuntuServer",
        "image_sku": "18.04-LTS",
   
        "azure_tags": {
          "Description": "Packer exercises for DevOps Bootcamp"
        },
    
        "location": "West US",
        "temp_resource_group_name": "RG-Brent-PACKERTMP",
        "vm_size": "Standard_DS2_v2",

        "shared_image_gallery_destination": {
          "subscription": "7d1ccfce-a8a0-4ece-9c3b-30b81bc721f8",
          "resource_group": "RG-brent-bootcamp",
          "gallery_name": "SIG_brent_bootcamp",
          "image_name": "Ubuntu1804",
          "replication_regions": ["westus"],
          "image_version": "1.0.0"
      },
      "managed_image_name": "Ubuntu1804",
      "managed_image_resource_group_name": "RG-brent-bootcamp",
      "ssh_username": "bootcamp"
    }
  ],
  "provisioners": [
    {
    "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'",
    "inline": [
      "apt-get update",
      "apt-get upgrade -y",

      "/usr/sbin/waagent -force -deprovision+user && export HISTSIZE=0 && sync"
    ],
    "inline_shebang": "/bin/sh -x",
    "type": "shell"
    }
  ]
}
EOF
```

```
packer build /tmp/ubuntu1804.json
```

**(note: it make take a quite a while for Packer to publish to the SIG, please be patient!)**

5. Get the ID of the new custom image verison.

```
IMAGE_ID=$(az sig image-version show \
  --gallery-name $GALLERY \
  --resource-group $RESOURCE_GROUP \
  --gallery-image-definition $IMAGE \
  --gallery-image-version "1.0.0" \
  --query 'storageProfile.source.id' \
  --output tsv)
```

6. Redo section 6.3.2 using our new custom image, starting from step 3. Only a minor change to step 9 is required to use our custom image.

```
VMSS_NAME=VMSS-brent-bootcamp
az vmss create \
  --resource-group $RESOURCE_GROUP \
  --name $VMSS_NAME \
  --vm-sku Standard_B1s \
  --upgrade-policy-mode automatic \
  --admin-username azureuser \
  --ssh-key-values /tmp/id_rsa.pub \
  --instance-count 2 \
  --custom-data /tmp/cloud-init-vmss.txt \
  --image $IMAGE_ID
```