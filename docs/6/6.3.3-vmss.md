# Azure Virtual Machine Scale Sets (VMSS)

In this section we will demonstrate how Virtual Machine Scale Sets (VMSS) work in Azure. We will build upon the learnings from previous sections and use a VMSS to host our simple website. Web assets will be hosted from shared storage in an Azure Storage account. We will then generate some artificual load to make sure scaling is working as expected.

## Create an VMSS and serve content from an Azure Storage Account

1. Log into Azure CLI and select the correct subscription

```
az login
az acccount set --subscription "liatrio-sandbox"
```

2. Create resource group for the VMSS and associated resources.

```
az group create --name RG-brent-bootcamp --location westus
```

3. Create storage account and file share.

```
az storage account create \
  --name brentbasicwebsite123 \
  --resource-group RG-brent-bootcamp \
  --location westus
```

4. Get storage access key for new storage account

```
STORAGEKEY=$(az storage account keys list --resource-group RG-brent-bootcamp --account-name brentbasicwebsite123 --query "[0].value" | tr -d '"')
```

5. Create file share

```
az storage share create \
  --name brent-web-fileshare \
  --quota 1 \
  --account-name brentbasicwebsite123 \
  --account-key $STORAGEKEY
```

6. Create index.html that returns the hostname of the VM.

```
cat <<EOF > /tmp/index.html
<html>
<body>
<p>hostname is: $(hostname)</p>
</body>
</html>
EOF
```

7. Upload web assets to storage account.

```
az storage file upload \
  --account-name brentbasicwebsite123 \
  --account-key $STORAGEKEY \
  --share-name brent-web-fileshare \
  --source "index.html" \
  --path "index.html"
```

8. Update cloud-init script for VMSS and mounting Azure Files.

```
#cloud-config
package_update: true
package_upgrade: true
packages:
  - apache2
  - cifs-utils
runcmd:
  - [ ls, -l, / ]
```

9. Create VMSS.

```
az vmss create \
  --resource-group RG-brent-bootcamp \
  --name VMSS-brent-bootcamp \
  --image UbuntuLTS \
  --vm-sku Standard_B1s \
  --upgrade-policy-mode automatic \
  --admin-username azureuser \
  --ssh-key-values /tmp/id_rsa.pub \
  --instance-count 2 \
  --custom-data /tmp/cloud-init.txt
```

10. Add load balancing rule

```
az network lb rule create \
  --resource-group RG-brent-bootcamp \
  --name myLoadBalancerRuleWeb \
  --lb-name VMSS-brent-bootcampLB \
  --backend-pool-name VMSS-brent-bootcampLBBEPool \
  --backend-port 80 \
  --frontend-ip-name loadBalancerFrontEnd \
  --frontend-port 80 \
  --protocol tcp
```

11. Get public IP for load balancer and test website access.

```
az network public-ip show \
    --resource-group RG-brent-bootcamp \
    --name VMSS-brent-bootcampLBPublicIP \
    --query [ipAddress] \
    --output tsv
```

12. Create autoscaling rule.

```
TBD
```

13. Generate some load and make sure scaling works.

```
TBD
```

```
az vmss list-instances \
  --resource-group myResourceGroupScaleSet \
  --name myScaleSet \
  --output table
```

14. Cleanup resources

```
az group delete -n RG-brent-bootcamp
```