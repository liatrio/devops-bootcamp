# Azure Virtual Machine Scale Sets (VMSS)

In this section we will demonstrate how Virtual Machine Scale Sets (VMSS) work in Azure. We will build upon the learnings from previous sections and use a VMSS to host our simple website. Web assets will be hosted from shared storage in an Azure Storage account. We will then generate some artificual load to make sure scaling is working as expected.

## Create an VMSS and serve content from an Azure Storage Account

1. Log into Azure CLI and select the correct subscription

```
az login
az acccount set --subscription "liatrio-sandbox"
```

2. Create resource group for the VMSS and associated resources.

```
RESOURCE_GROUP=RG-brent-bootcamp
LOCATION=westus
az group create --name $RESOURCE_GROUP --location $LOCATION
```

3. Create storage account and file share.

```
STORAGE_ACCOUNT=brentbasicwebsite123
az storage account create \
  --name $STORAGE_ACCOUNT \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION
```

4. Get storage access key for new storage account

```
STORAGE_KEY=$(az storage account keys list --resource-group $RESOURCE_GROUP --account-name $STORAGE_ACCOUNT --query "[0].value" | tr -d '"')
```

5. Create file share

```
SHARE_NAME=brent-web-fileshare
az storage share create \
  --name $SHARE_NAME \
  --quota 1 \
  --account-name $STORAGE_ACCOUNT \
  --account-key $STORAGE_KEY
```

6. Create index.js that returns the hostname of the VM, same one we used in section 6.3.2.

```
mkdir /tmp/webapp/
cat <<EOF > /tmp/webapp/index.js
var express = require('express')
var app = express()
var os = require('os');
app.get('/', function (req, res) {
  res.send('DevOps Bootcamp sample app running on host ' + os.hostname() + '!')
})
app.listen(3000, function () {
  console.log('Test app listening on port 3000!')
})
EOF
```

7. Build the Node.js app locally first.

```
cd /tmp/webapp
npm init --yes
npm install express -y
```

7. Upload Node.js app to Azure storage account.

```
az storage file upload-batch \
  --account-key $STORAGE_KEY \
  --account-name $STORAGE_ACCOUNT \
  --destination $SHARE_NAME --source /tmp/webapp
```

8. Update cloud-init script for VMSS and mounting Azure Files.

```
cat <<EOF > /tmp/cloud-init-vmss.txt
#cloud-config
package_update: true
package_upgrade: true
packages:
  - nginx
  - nodejs
  - npm
write_files:
  - owner: www-data:www-data
  - path: /etc/nginx/sites-available/default
    content: |
      server {
        listen 80;
        location / {
          proxy_pass http://localhost:3000;
          proxy_http_version 1.1;
          proxy_set_header Upgrade \$http_upgrade;
          proxy_set_header Connection keep-alive;
          proxy_set_header Host \$host;
          proxy_cache_bypass \$http_upgrade;
        }
      }
runcmd:
  - mkdir "/mnt/webapp"
  - 'mount -t cifs //$STORAGE_ACCOUNT.file.core.windows.net/$SHARE_NAME /mnt/webapp -o vers=3.0,username=$STORAGE_ACCOUNT,password=$STORAGE_KEY,dir_mode=0755,file_mode=0664'
  - service nginx restart
  - cd "/mnt/webapp"
  - nodejs index.js
EOF
```

9. Create VMSS.

```
VMSS_NAME=VMSS-brent-bootcamp
az vmss create \
  --resource-group $RESOURCE_GROUP \
  --name $VMSS_NAME \
  --image UbuntuLTS \
  --vm-sku Standard_B1s \
  --upgrade-policy-mode automatic \
  --admin-username azureuser \
  --ssh-key-values /tmp/id_rsa.pub \
  --instance-count 2 \
  --public-ip-per-vm \
  --custom-data /tmp/cloud-init-vmss.txt
```

**(note: it make take a few minutes for cloud-init to install packages and perform updates)**

10. Add load balancing rule

```
az network lb rule create \
  --resource-group $RESOURCE_GROUP \
  --name myLoadBalancerRuleWeb \
  --lb-name "${VMSS_NAME}LB" \
  --backend-pool-name "${VMSS_NAME}LBBEPool" \
  --backend-port 80 \
  --frontend-ip-name loadBalancerFrontEnd \
  --frontend-port 80 \
  --protocol tcp
```

11. Get public IP for load balancer and test website access.

```
az network public-ip show \
    --resource-group $RESOURCE_GROUP \
    --name "${VMSS_NAME}LBPublicIP" \
    --query [ipAddress] \
    --output tsv
```

12. Create autoscaling rule.

```
TBD
```

13. Generate some load and make sure scaling works.

```
TBD
```

```
az vmss list-instances \
  --resource-group myResourceGroupScaleSet \
  --name myScaleSet \
  --output table
```

14. Cleanup resources

```
az group delete -n $RESOURCE_GROUP
```