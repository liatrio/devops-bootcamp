# Azure Virtual Machines

In this section we will demonstrate how to create a virtual machine instance in Azure from a marketplace image and perform post configuration using a cloud-init script.

## Create an Azure VM from a marketplace image and configure with cloud-init

1. Log into Azure CLI and select the correct subscription

```
az login
az acccount set --subscription "liatrio-sandbox"
```

2. List VM images available in an Azure region that are based on Ubuntu Linux.

```
az vm image list -f Ubuntu \
  --publisher Canonical \
  --location westus --all \
  --output table --sku 18.04
```

3. Create a cloud-init script that install NGINX and a simple Node.js application.

```
cat <<EOF > /tmp/cloud-init-vmss.txt
#cloud-config
package_update: true
package_upgrade: true
packages:
  - nginx
  - nodejs
  - npm
write_files:
  - owner: www-data:www-data
  - path: /etc/nginx/sites-available/default
    content: |
      server {
        listen 80;
        location / {
          proxy_pass http://localhost:3000;
          proxy_http_version 1.1;
          proxy_set_header Upgrade \$http_upgrade;
          proxy_set_header Connection keep-alive;
          proxy_set_header Host \$host;
          proxy_cache_bypass \$http_upgrade;
        }
      }
  - owner: azureuser:azureuser
  - path: /home/azureuser/bootcamp/index.js
    content: |
      var express = require('express')
      var app = express()
      var os = require('os');
      app.get('/', function (req, res) {
        res.send('DevOps Bootcamp sample app running on host ' + os.hostname() + '!')
      })
      app.listen(3000, function () {
        console.log('Test app listening on port 3000!')
      })
runcmd:
  - service nginx restart
  - cd "/home/azureuser/bootcamp"
  - npm init
  - npm install express -y
  - nodejs index.js
EOF
```

4. Generate some temporary SSH keys to use for the new VM.

```
cd /tmp
ssh-keygen -m PEM -t rsa -b 4096
```

5. Create resource group.

```
RESOURCE_GROUP=RG-brent-bootcamp
LOCATION=westus
az group create --name $RESOURCE_GROUP --location $LOCATION
```

6. Create VM using cloud-init script.

```
VM_NAME=brentw-test-VM
az vm create \
    --resource-group $RESOURCE_GROUP \
    --name $VM_NAME \
    --size Standard_B1s \
    --image UbuntuLTS \
    --admin-username azureuser \
    --ssh-key-values /tmp/id_rsa.pub \
    --custom-data /tmp/cloud-init.txt
```

**(note: copy the public IP that is output after VM creation)**
**(note: it make take a few minutes for cloud-init to install packages and perform updates)**

7. Make sure you can SSH into VM using private key you generated in step 4.

```
ssh -i /tmp/id_rsa azureuser@public_IP
```

8. Open web traffic to the VM.

```
az vm open-port --port 80 \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME
```

9. Test you can reach the website.

10. Cleanup.

```
az group delete -n $RESOURCE_GROUP
```
