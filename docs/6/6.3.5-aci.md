# Azure Container Instances (ACI)

While building VMs and VM scale sets are appropriate in some cases, this would probably be a wasteful approach to deploy a small Node.js application. Instead of deploying an entire server to host our application, we will package our small application in a Docker image and launch an instance in ACI.

[Azure Container Instances](https://azure.microsoft.com/en-us/services/container-instances/) provides a fast and simple way to run containers in Azure, without having to manage any virtual machines and without having to adopt a higher-level service. When more complicated scenarios are required, such as service discovery across multiple containers, automatic scaling, and coordinated application upgrades, it is best to use Azure Kubernetes Service (AKS) instead of ACI. We will cover AKS in the next section. It is actually possible to use ACI as burst capacity for AKS, so the solutions are not mutually exclusive.

## Create a Docker image and launch an instance in ACI

1. We will use the same Node.js app as the previous sections.

```
mkdir /tmp/aci-bootcamp
mv /tmp/webapp /tmp/aci-bootcamp/
```

2. Create Dockerfile

```
cat <<EOF > /tmp/aci-bootcamp/Dockerfile
FROM node:8.9.3-alpine
RUN mkdir -p /usr/src/app
COPY webapp/ /usr/src/app/
WORKDIR /usr/src/app
RUN npm install
CMD node /usr/src/app/index.js
EXPOSE 3000
EOF
```

3. Build the Docker image.

```
cd /tmp/
docker build ./aci-bootcamp -t aci-bootcamp
docker image ls
```

4. Run the container locally to make sure it works. You should be able to navigate to http://localhost:5000/

```
docker run -d -p 5000:3000 aci-bootcamp
```

5. Log into Azure CLI and select the correct subscription

```
az login
az acccount set --subscription "liatrio-sandbox"
```

6. Create resource group for ACR and ACI resources.

```
RESOURCE_GROUP=RG-brent-bootcamp
LOCATION=westus
az group create --name $RESOURCE_GROUP --location $LOCATION
```

7. Create an ACR instace to host our Docker images.

```
REGISTRY_NAME=brentdevopsbootcamp
az acr create \
  --name $REGISTRY_NAME \
  --resource-group $RESOURCE_GROUP \
  --sku Standard
```

8. Log into the ACR instance.

```
az acr login --name $REGISTRY_NAME
```

9. Get the server address of your ACR instance.

```
DOCKER_SERVER=$(az acr show \
  --name $REGISTRY_NAME \
  --query loginServer \
  --output tsv)
```

10. Tag the image and push to ACR.

```
docker tag aci-bootcamp $DOCKER_SERVER/aci-bootcamp:v1
```

```
docker push $DOCKER_SERVER/aci-bootcamp:v1
```

11. List images in ACR instance.

```
az acr repository list --name $REGISTRY_NAME --output table
```

12. Create service principal to use with ACR.

```
SP_NAME="http://brent-devops-bootcamp-acr"
```

```
REGISTRY_ID=$(az acr show --name $REGISTRY_NAME --query id --output tsv)
```

```
DOCKER_PASSWORD=$(az ad sp create-for-rbac --name $SP_NAME --scopes $REGISTRY_ID --role acrpull --query password --output tsv)
```

```
DOCKER_USERNAME=$(az ad sp show --id $SP_NAME  --query appId --output tsv)
```

13. Launch an instance in ACR.

```
az container create \
  --resource-group $RESOURCE_GROUP \
  --name aci-bootcamp \
  --image $DOCKER_SERVER/aci-bootcamp:v1 \
  --cpu 1 \
  --memory 1 \
  --registry-login-server $DOCKER_SERVER \
  --registry-username $DOCKER_USERNAME \
  --registry-password $DOCKER_PASSWORD \
  --dns-name-label devopsbootcamp \
  --ports 3000
```

14. Check deploy status, access container logs and test access to the site.

```
az container show \
  --resource-group $RESOURCE_GROUP \
  --name aci-bootcamp \
  --query instanceView.state
```

```
az container show \
  --resource-group $RESOURCE_GROUP \
  --name aci-bootcamp \
  --query ipAddress.fqdn
```

```
az container logs \
  --resource-group $RESOURCE_GROUP \
  --name aci-bootcamp
```

15. Cleanup resources and service principals.

```
az group delete -n $RESOURCE_GROUP
az ad sp delete --id $DOCKER_USERNAME
```
