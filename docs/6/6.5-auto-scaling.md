# Auto Scaling

## Exercise 1 - Create EC2 instance with User Data

### About User Data

EC2 instances can be configured using the User Data option, which runs commands when a new instance is launched. User Data can accomplish anything that shell commands can. You can think of it at being similar to the shell provisioner in Vagrant.

- Read more about User Data in the [AWS documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-add-user-data).

User Data can be specified when launching an EC2 instances via the AWS Console or via the AWS CLI by utilizing the --user-data flag. It is common to store User Data scripts in an S3 bucket and utilize them with the --user-data flag.

1. Using your notes from previous sections write a shell script which does the following:
  1. Install Tomcat and runs as a service
  2. Install Maven
  3. Download and build a Java Web application such as Spring Petclinic
  4. Deploy your application to Tomcat and make is accessible at http://[PUBLIC_IP]/[APPLICATION_NAME]

2. Create a security group to expose Tomcat (port 8080).

3. Create an EC2 instance using your User Data shell script. Refer to the AWS CLI command you used in the previous section, add the `--user-data` flag and make sure to set the correct tags and the security group created above.

4. Once you have your User Data script working and instance setup create a second EC2 instance using the same User Data. Make sure to change the instance name to differentiate it from the first.

**Tips**
- Since the EC2 instance is a different environment than you previously installed this software on you will need to adapt the steps from your notes.
- Start off with a simple User Data script that only has a few steps, test those, fix any problems and then add more steps. Be patience and remember understanding how to trouble shoot installing software in different environments is an important skill.
- You can find output from your User Data script in `/var/log/messages`

### Deliverables
- Understand how User Data can be utilized to provision instances
- Create a functional User Data script
- Create two identical (except the tags) EC2 instances using the User Data script
- Navigate to the application running within a browser

## Exercise 2 - Setup Classic Load Balancer

Below are instructions for setting up a Classic Load Balancer for the two instances created in exercise 1. Apply these instructions to your application. Keep in mind that these instructions were created for Tomcat 8 running Spring-Petclinic. Make necessary changes for your situation.

1. Open to the Amazon [console](https://console.aws.amazon.com).
2. Select *EC2* from the *Services* menu and click *Load Balancers* in the left navigation bar.
3. Click *Create Load Balancer*.
4. Click **Create** under Classic Load Balancer.
5. Specify a name, such as <your-name>-dob-petclinic, add TCP port forwarding on port 8080 for Tomcat and click *Next: Assign Security Groups*.

<center>

![](img6/s1d.png)

</center>

6. Specify the same security group created in exercise 1. Click *Next: Configure Security Settings* and then *Next: Configure Health Check*.
7. Set *Ping Protocol* to TCP, *Ping Port* to 8080 and *Ping Path* to /petclinic (or the URL path to your application). These steps are important to ensure that the load balancer is properly setting the instances' healths. Hover over the question marks to get more information on the other settings. Click *Next: Add EC2 Instances*.
8. Select the instances created in exercise 1. Click *Next: Add Tags*.

<center>

![](img6/s5a.png)

</center>

9. Use Liatrio's recommended tag structure (outlined in 6.2) to create tags. Click *Review and Create*.
10. Review the settings and click *Create* to create the Classic Load Balancer.

<center>

![](img6/s7r.png)

</center>

11. Navigate to your Load Balancer in the list within the EC2 Console, and confirm that your instances are being load balanced and are healthy. If your Load Balancer is reflective of the image below, with the instances labeled as InService,

<center>

![](img6/fig4.png)

</center>

12. Navigate to the *DNS Name* of the load balancer (don't forgot to include the port and path of your application) and verify the application is being load balanced. Congratulations! You have now load balanced two automatically configured EC2 instances using User Data.

### Extended Understanding

Try stoping one of your instances.
- What is the health of the 

### Deliverables
- Discuss as a group the benefits of load balancing traffic.
- Follow the steps above to create a Classic Load Balancer for your two instances from Milestone Two.
- Be able to view the application through the load balancer address.



## Milestones for this Section
1. Understand how User Data can be utilized to provision instances
2. Implement EC2 User Data using the AWS CLI
3. Load Balance traffic between two instances
4. Create a Launch Configuration to replace steps one and two
5. Create an Auto Scaling Group using the Launch Configuration from step four
     - Associate the Auto Scaling Group with the Load Balancer from step three
     - Reference the Load Balancer's health checks with the Auto Scaling Group

> ### Milestone Three Deliverables
- Your group's two instances' traffic being load balanced by a Classic Load Balancer as visible from the AWS Console
- Demo your Load Balancer's settings including Description, Instances, Health Check, Listeners, Monitoring, and Tags

## 3. Launch Configurations

<center>

  ![](img6/s1c.png)

</center>

> ### Milestone Four - Create a Launch Configuration
- Discuss as a group the benefits of using Launch Configurations.
- Follow the steps above to create a Launch Configuration utilizing your User Data.

Below are instructions for setting up a Launch Configuration. Apply these instructions to your application. Keep in mind that these instructions were created for Tomcat 8 running Spring-Petclinic. Make necessary changes for your situation.

1. Navigate to the Amazon EC2 [console](https://us-west-2.console.aws.amazon.com/ec2/v2/home?region=us-west-2#LoadBalancers:).
2. Under Auto Scaling, click Launch Configurations.
3. Click Create Auto Scaling Group.
4. Continue to Create Launch Configuration.
5. Select the Amazon Linux AMI.
6. Name the Launch Configuration <YOUR-NAME>-launch-config.
7. On the Configure Details step, show advanced options.
8. Copy and paste the startup script from step 1 into this box.
9. See Figure 1 below.
10. Specify the jenkins security group.
11. You should now be automatically redirected to Create Auto Scaling Group. Navigate to Auto Scaling Groups if you did not get automatically redirected and proceed to step 4.

<center>

Figure 1:

  ![](img6/fig1a.png)

</center>

> ### Milestone Four Deliverables
- Ensure that your Launch Configuration is configured correctly.

## 4. Auto Scaling Groups

<center>

  ![](img6/asg.png)

</center>

> ## Milestone Five
- Create an Auto Scaling Group using the Launch Configuration
- Associate the Auto Scaling Group with the Load Balancer
- Reference the Load Balancer's health checks with the Auto Scaling Group
- Discuss as a group the benefits of using an Auto Scaling Group.
   - use cases of an Auto Scaling Group of different sizes
   - with and without Load Balancers
   - using EC2 Health Checks vs. Load Balancing Health Checks
   - groups of size one
   - pricing

Below are instructions for setting up an Auto Scaling Group. Apply these instructions to your application. Keep in mind that these instructions were created for Tomcat 8 running Spring-Petclinic. Make necessary changes for your situation.

1. Navigate to the Amazon EC2 [console](https://us-west-2.console.aws.amazon.com/ec2/v2/home?region=us-west-2#LoadBalancers:) and select Auto Scaling Groups if not automatically redirected already.
2. For the group name, name it <your-name>-auto-scaling-group.
3. Specify to start with 2 instances.
4. Specify us-west-2b for the subnet, as this is where the instances in the ELB are located. For real scenarios, it is suggested to use more than one subnet to provide fault tolerance.
5. See Figure 1, a screenshot taken from the Load Balancer settings specifying which subnet the instances are located in.
6. Under Advanced Details, check the box for Receive Traffic from One or More Load Balancers.
7. Specify the Classic Load Balancer created in step 2.
8. Specify ELB for the Health Check type to reference the Health Check configuration made when the ELB was created.
9. Moving forward, confirm keeping this group at its initial size. This will make sure the group always stays at 2.
10. For real world scenarios, policies would be created to spin up a maximum number of instances using CloudWatch alarms.
11. Under Configure Tags, be sure to add Project and DOB, and Name with <your-name>-auto-scaling.
12. Review your settings and compare with Figure 2.
13. Continue to View Auto Scaling Groups and confirm your Auto Scaling Group is in service and has your original ELB instances reflected under Instances.

<center>

Figure 1:

  ![](img6/f1a.png)

Figure 2:

  ![](img6/f2a.png)

</center>

> ## Milestone Five Deliverables

<center>

  ![](img6/elb.png)

</center>

Navigate to the Load Balancer. Your original two instances belonging to the Load Balancer should be there along with two new instances that were spun up in accordance with the Auto Scaling group and your Launch Configuration.

<center>

  ![](img6/instanceid.png)

</center>

As you can see in the above image, the instances being spun up belonging to the Auto Scaling group are now attached to the Load Balancer. One is InService as it can be pinged according to our Load Balancer Health Check configuration at /petclinic on port 8080. The one that is OutOfService is currently installing Tomcat 8 and building Spring-petclinic.

<center>

  ![](img6/clb.png)

</center>

# Deliverable for Consultants
1. What is this tool?
2. How is it used in an enterprise?
3. Licensing costs
4. Liatrio's POV/uses for Load Balancers
5. Explain pros and cons
6. Create high level deck explaining Load Balancers. Coordinate with your team to also have a technical demo
7. Once an engineer has completed this exercise work with them to run through spinning up new instances
