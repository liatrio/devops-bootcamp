# 7.3 RBAC

## BACKGROUND ON RBAC

## Grant New Permissions to a ServiceAccount

1. Create a namespace imperatively for jenkins with aid of the `kubectl create --help` command.

2. Install jenkins in the new "jenkins" namespace using helm.
`helm repo add jenkins https://charts.jenkins.io`<br>
`helm repo update`<br>
`helm install jenkins jenkins/jenkins -n jenkins --version 3.9.3`
   - The name of the chart is jenkins/jenkins - found by running `helm search repo jenkins`.

3. Discovery<br>
After installing the jenkins helm chart, what new roles did it add in the "jenkins" namespace? Role bindings? Service accounts?

4. Create credentials using a kubernetes secret. Replace the values for username and password with your own:
```
apiVersion: v1
kind: Secret
metadata:
# this is the jenkins id
  name: liatrio-jenkins-secret
  namespace: jenkins
  labels:
# secret type
    "jenkins.io/credentials-type": "usernamePassword"
  annotations:
# description - can not be a label as spaces are not allowed
    "jenkins.io/credentials-description" : "credentials from Kubernetes"
type: Opaque
stringData:
  username: YOUR_USERNAME
  password: 'YOUR_PASSWORD'
```

5. Setup jenkins and install the "Kubernetes Credentials Provider" plugin. You should notice a kubernetes store appear under "Scores Scoped to Jenkins" in the "Credentials" section but your secret isn't yet showing up. This is because jenkins does not have the ability to access kubernetes secrets like the one created above. Having jenkins access this new secret will require giving it a new role and rolebinding in kubernetes.
![](img7/before-secrets-rbac.svg ':class=img-center')

5. Create a new role for jenkins named "jenkins-read-secrets" in the "jenkins" namespace to read kubernetes secrets. Use the labels and annotations specificed below. Give this role a rule to get/watch/list secrets.

```
  annotations:
    meta.helm.sh/release-name: jenkins
    meta.helm.sh/release-namespace: jenkins
  labels:
    app.kubernetes.io/component: jenkins-controller
    app.kubernetes.io/instance: jenkins
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: jenkins
    helm.sh/chart: jenkins-3.9.3
```

6. Create a rolebinding for your "jenkins-read-secrets" role in the "jenkins" namespace using the same name and annotations/labels as in the previous step. Specify the same ServiceAccount you found during the "Discovery" step.

7. Refresh the "Credentials" pages and you'll now be able to see your kubernetes secret in jenkins.
![](img7/after-secrets-rbac.svg ':class=img-center')

## Imperative RBAC
Service accounts, (cluster) roles, and (cluster) role bindings can also be created imperatively with `kubectl create --help`.

1. Create a service account named "fluentd" in the "kube-system" namespace.

3. Create a cluster role "fluentd" with the ability to get, list, and watch pods.

4. Create a cluster role binding "fluentd" and configure it to use the service account and role you just created.